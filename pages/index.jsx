import Head from "next/head";
import MainSwiper from "../components/uiElements/swiper";
import CategoryButtons from "../components/categoryButtons/categoryButtons";
import styles from "../styles/pages/index.module.css";
import { API_URL } from "../config/index";

export default function Home({ uniqueBooksCategory }) {
  return (
    <div>
      <Head>
        <title>Mirzaei Book Store</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={styles.main}>
        <MainSwiper booksData={uniqueBooksCategory} />
        <CategoryButtons />
      </main>
    </div>
  );
}

export async function getStaticProps() {
  const qs = require("qs");
  const query = qs.stringify(
    {
      populate: "*",
      sort: ["createdAt:desc"],
    },
    {
      encodeValuesOnly: true,
    }
  );

  const response = await fetch(`${API_URL}/api/books?${query}`);
  const result = await response.json();
  const booksData = result.data.slice(0, 20);
  const uniqueBooksCategory = [];
  const fields = [];
  booksData.forEach((element) => {
    const isIncluded = fields.includes(
      element.attributes.category.data.attributes.title
    );
    if (!isIncluded) {
      fields.push(element.attributes.category.data.attributes.title);
      uniqueBooksCategory.push(element);
    }
  });

  return {
    props: { uniqueBooksCategory },
    revalidate: 30,
  };
}
